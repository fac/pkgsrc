From: Markus Koschany <apo@debian.org>
Date: Sun, 2 Sep 2018 16:17:58 +0200
Subject: CVE-2018-15908

Bug-Debian: https://bugs.debian.org/907332
Origin: http://git.ghostscript.com/?p=ghostpdl.git;a=commit;h=0d3901189f245232f0161addf215d7268c4d05a3
---
 psi/zfile.c | 18 +++++++++++++++++-
 1 file changed, 17 insertions(+), 1 deletion(-)

diff --git a/psi/zfile.c b/psi/zfile.c
index e2f8353..0e7a1db 100644
--- psi/zfile.c
+++ psi/zfile.c
@@ -712,7 +712,23 @@ ztempfile(i_ctx_t *i_ctx_p)
     }
 
     if (gp_file_name_is_absolute(pstr, strlen(pstr))) {
-        if (check_file_permissions(i_ctx_p, pstr, strlen(pstr),
+        int plen = strlen(pstr);
+        const char *sep = gp_file_name_separator();
+#ifdef DEBUG
+        int seplen = strlen(sep);
+        if (seplen != 1)
+            return_error(gs_error_Fatal);
+#endif
+        /* strip off the file name prefix, leave just the directory name
+         * so we can check if we are allowed to write to it
+         */
+        for ( ; plen >=0; plen--) {
+            if (pstr[plen] == sep[0])
+                break;
+        }
+        memcpy(fname, pstr, plen);
+        fname[plen] = '\0';
+        if (check_file_permissions(i_ctx_p, fname, strlen(fname),
                                    "PermitFileWriting") < 0) {
             return_error(e_invalidfileaccess);
         }
