From: Markus Koschany <apo@debian.org>
Date: Sun, 2 Sep 2018 19:40:01 +0200
Subject: dSAFER sandbox bybass part4

CVE-2018-16511

Bug-Debian: https://bugs.debian.org/907332
Origin: http://git.ghostscript.com/?p=ghostpdl.git;a=commitdiff;h=0edd3d6c
---
 base/gserrors.h | 1 +
 psi/ztype.c     | 3 +++
 2 files changed, 4 insertions(+)

diff --git a/base/gserrors.h b/base/gserrors.h
index c3d8267..80593ce 100644
--- base/gserrors.h
+++ base/gserrors.h
@@ -39,6 +39,7 @@
 #define gs_error_undefinedresult (-23)
 #define gs_error_VMerror (-25)
 #define gs_error_unregistered (-28)
+#define gs_error_stackunderflow (-17)
 
 #define gs_error_hit_detected (-99)
 
diff --git a/psi/ztype.c b/psi/ztype.c
index 18ee40d..48d017c 100644
--- psi/ztype.c
+++ psi/ztype.c
@@ -76,6 +76,7 @@ ztype(i_ctx_t *i_ctx_p)
         /* Must be either a stack underflow or a t_[a]struct. */
         check_op(2);
         {                       /* Get the type name from the structure. */
+            if ((r_has_type(&op[-1], t_struct) || r_has_type(&op[-1], t_astruct)) && op[-1].value.pstruct != 0x00) {
             const char *sname =
                 gs_struct_type_name_string(gs_object_type(imemory,
                                                           op[-1].value.pstruct));
@@ -84,6 +85,8 @@ ztype(i_ctx_t *i_ctx_p)
 
             if (code < 0)
                 return code;
+            } else
+                return_error(gs_error_stackunderflow);
         }
         r_set_attrs(op - 1, a_executable);
     } else {
