From: Markus Koschany <apo@debian.org>
Date: Sun, 2 Sep 2018 19:46:23 +0200
Subject: dSAFER sandbox bybass part5

Bug-Debian: https://bugs.debian.org/907332
Origin: http://git.ghostscript.com/?p=ghostpdl.git;a=commitdiff;h=a054156d
---
 Resource/Init/gs_init.ps | 17 ++++++++++++++++-
 1 file changed, 16 insertions(+), 1 deletion(-)

diff --git a/Resource/Init/gs_init.ps b/Resource/Init/gs_init.ps
index cd016f9..f1a3eed 100644
--- Resource/Init/gs_init.ps
+++ Resource/Init/gs_init.ps
@@ -2007,6 +2007,19 @@ readonly def
             concatstrings concatstrings .generate_dir_list_templates
         } if
       ]
+      /PermitFileWriting [
+          currentuserparams /PermitFileWriting get aload pop
+          (TMPDIR) getenv not
+          {
+            (TEMP) getenv not
+            {
+              (TMP) getenv not
+              {
+                (/temp) (/tmp)
+              } if
+            } if
+          } if
+      ]
       /LockFilePermissions //true
     >> setuserparams
   }
@@ -2054,7 +2067,9 @@ readonly def
 % the file can be deleted later, even if SAFER is set.
 /.tempfile {
   .tempfile	% filename file
-  //SAFETY /tempfiles get 2 .argindex //true .forceput
+    //SAFETY /safe get not { % only add the filename if we're not yet safe
+    //SAFETY /tempfiles get 2 .argindex //true .forceput
+  } if
 } .bind executeonly odef
 
 % If we are running in SAFER mode, lock things down
