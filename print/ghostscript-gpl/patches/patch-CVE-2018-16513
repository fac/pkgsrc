From: Markus Koschany <apo@debian.org>
Date: Sun, 2 Sep 2018 19:59:03 +0200
Subject: dSAFER sandbox bybass part6

CVE-2018-16513

Bug-Debian: https://bugs.debian.org/907332
Origin: http://git.ghostscript.com/?p=ghostpdl.git;a=commitdiff;h=b326a716
---
 psi/zcolor.c | 24 +++++++++++++-----------
 1 file changed, 13 insertions(+), 11 deletions(-)

diff --git a/psi/zcolor.c b/psi/zcolor.c
index 0f5be54..14f55bb 100644
--- psi/zcolor.c
+++ psi/zcolor.c
@@ -277,23 +277,25 @@ zsetcolor(i_ctx_t * i_ctx_p)
             ref     *pImpl, pPatInst;
             int     ptype;
 
-            code = dict_find_string(op, "Implementation", &pImpl);
-            if (code < 0)
-                return code;
-            code = array_get(imemory, pImpl, 0, &pPatInst);
-            if (code < 0)
+            if ((code = dict_find_string(op, "Implementation", &pImpl)) < 0)
                 return code;
-            cc.pattern = r_ptr(&pPatInst, gs_pattern_instance_t);
-            n_numeric_comps = ( pattern_instance_uses_base_space(cc.pattern)
+            if (code > 0) {
+                code = array_get(imemory, pImpl, 0, &pPatInst);
+                if (code < 0)
+                    return code;
+                cc.pattern = r_ptr(&pPatInst, gs_pattern_instance_t);
+                n_numeric_comps = ( pattern_instance_uses_base_space(cc.pattern)
                                   ? n_comps - 1
                                   : 0 );
-            (void)dict_int_param(op, "PatternType", 1, 2, 1, &ptype);
-            is_ptype2 = ptype == 2;
+                (void)dict_int_param(op, "PatternType", 1, 2, 1, &ptype);
+                is_ptype2 = ptype == 2;
+            } else
+                n_numeric_comps = 0;
         } else
             n_numeric_comps = 0;
-        num_offset = 1;
+         num_offset = 1;
     } else
-        n_numeric_comps = n_comps;
+            n_numeric_comps = n_comps;
 
     /* gather the numeric operands */
     code = float_params(op - num_offset, n_numeric_comps, cc.paint.values);
