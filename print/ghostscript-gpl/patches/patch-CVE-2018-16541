From: Markus Koschany <apo@debian.org>
Date: Sun, 2 Sep 2018 19:04:45 +0200
Subject: dSAFER sandbox bybass part2

CVE-2018-16541

Bug-Debian: https://bugs.debian.org/907332
Origin: http://git.ghostscript.com/?p=ghostpdl.git;a=commitdiff;h=241d9111
---
 psi/imain.c | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/psi/imain.c b/psi/imain.c
index f86973b..09b7191 100644
--- psi/imain.c
+++ psi/imain.c
@@ -839,6 +839,17 @@ gs_main_finit(gs_main_instance * minst, int exit_status, int code)
             }
             i_ctx_p = minst->i_ctx_p; /* interp_reclaim could change it. */
         }
+
+       if (i_ctx_p->pgs != NULL && i_ctx_p->pgs->device != NULL &&
+            gx_device_is_null(i_ctx_p->pgs->device)) {
+            /* if the job replaced the device with the nulldevice, we we need to grestore
+               away that device, so the block below can properly dispense
+               with the default device.
+             */
+            int code = gs_grestoreall(i_ctx_p->pgs);
+            if (code < 0) return_error(gs_error_Fatal);
+        }
+
 #ifndef PSI_INCLUDED
         if (i_ctx_p->pgs != NULL && i_ctx_p->pgs->device != NULL) {
             gx_device *pdev = i_ctx_p->pgs->device;
